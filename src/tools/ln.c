
#include <stdio.h>

typedef unsigned short uint16_t;

#include "crush_ln_table.h"

static inline int val(int i) {
	return crush_ln_table[i];
}

int is_linear(int i, int j) {
   int first = val(i);
   int last = val(j);
   int delta = (last - first) / (j - i);
   int mod = (last - first) % (j - i);

   int cur_val = first;
   int n;
   for (n = i + 1; n <= j; n++) {
	   // printf("n=%d i=%d j=%d\n", n, i , j);
	   cur_val = first + (n - i) * delta + ((n - i ) * mod) / (j - i);
	   // printf("cur_val=%d val=%d\n", cur_val, val(n));
	   if (cur_val - val(n) < -10 || cur_val - val(n) > 10) {
		   return 0;
	   }
   }

   return 1;
}

int ln_precision10(int n) {
if (n < 2) return (0 + (n - 0) * 4096 + ((n - 0) * 0) / 1);
if (n < 3) return (4096 + (n - 1) * 2396 + ((n - 1) * 0) / 1);
if (n < 4) return (6492 + (n - 2) * 1700 + ((n - 2) * 0) / 1);
if (n < 5) return (8192 + (n - 3) * 1318 + ((n - 3) * 0) / 1);
if (n < 6) return (9510 + (n - 4) * 1078 + ((n - 4) * 0) / 1);
if (n < 7) return (10588 + (n - 5) * 910 + ((n - 5) * 0) / 1);
if (n < 8) return (11498 + (n - 6) * 790 + ((n - 6) * 0) / 1);
if (n < 9) return (12288 + (n - 7) * 696 + ((n - 7) * 0) / 1);
if (n < 10) return (12984 + (n - 8) * 622 + ((n - 8) * 0) / 1);
if (n < 11) return (13606 + (n - 9) * 563 + ((n - 9) * 0) / 1);
if (n < 12) return (14169 + (n - 10) * 515 + ((n - 10) * 0) / 1);
if (n < 13) return (14684 + (n - 11) * 473 + ((n - 11) * 0) / 1);
if (n < 14) return (15157 + (n - 12) * 437 + ((n - 12) * 0) / 1);
if (n < 15) return (15594 + (n - 13) * 408 + ((n - 13) * 0) / 1);
if (n < 16) return (16002 + (n - 14) * 382 + ((n - 14) * 0) / 1);
if (n < 18) return (16384 + (n - 15) * 348 + ((n - 15) * 0) / 2);
if (n < 20) return (17080 + (n - 17) * 311 + ((n - 17) * 0) / 2);
if (n < 22) return (17702 + (n - 19) * 281 + ((n - 19) * 1) / 2);
if (n < 24) return (18265 + (n - 21) * 257 + ((n - 21) * 1) / 2);
if (n < 27) return (18780 + (n - 23) * 232 + ((n - 23) * 0) / 3);
if (n < 30) return (19476 + (n - 26) * 207 + ((n - 26) * 1) / 3);
if (n < 33) return (20098 + (n - 29) * 187 + ((n - 29) * 2) / 3);
if (n < 37) return (20661 + (n - 32) * 169 + ((n - 32) * 0) / 4);
if (n < 41) return (21337 + (n - 36) * 151 + ((n - 36) * 3) / 4);
if (n < 46) return (21944 + (n - 40) * 136 + ((n - 40) * 0) / 5);
if (n < 51) return (22624 + (n - 45) * 122 + ((n - 45) * 0) / 5);
if (n < 57) return (23234 + (n - 50) * 109 + ((n - 50) * 3) / 6);
if (n < 64) return (23891 + (n - 56) * 97 + ((n - 56) * 6) / 7);
if (n < 72) return (24576 + (n - 63) * 87 + ((n - 63) * 0) / 8);
if (n < 81) return (25272 + (n - 71) * 77 + ((n - 71) * 3) / 9);
if (n < 91) return (25968 + (n - 80) * 68 + ((n - 80) * 7) / 10);
if (n < 101) return (26655 + (n - 90) * 61 + ((n - 90) * 7) / 10);
if (n < 113) return (27272 + (n - 100) * 55 + ((n - 100) * 3) / 12);
if (n < 126) return (27935 + (n - 112) * 49 + ((n - 112) * 6) / 13);
if (n < 141) return (28578 + (n - 125) * 44 + ((n - 125) * 5) / 15);
if (n < 158) return (29243 + (n - 140) * 39 + ((n - 140) * 10) / 17);
if (n < 177) return (29916 + (n - 157) * 35 + ((n - 157) * 6) / 19);
if (n < 198) return (30587 + (n - 176) * 31 + ((n - 176) * 11) / 21);
if (n < 221) return (31249 + (n - 197) * 28 + ((n - 197) * 6) / 23);
if (n < 247) return (31899 + (n - 220) * 25 + ((n - 220) * 7) / 26);
if (n < 276) return (32556 + (n - 246) * 22 + ((n - 246) * 18) / 29);
if (n < 310) return (33212 + (n - 275) * 20 + ((n - 275) * 7) / 34);
if (n < 348) return (33899 + (n - 309) * 17 + ((n - 309) * 37) / 38);
if (n < 391) return (34582 + (n - 347) * 16 + ((n - 347) * 0) / 43);
if (n < 437) return (35270 + (n - 390) * 14 + ((n - 390) * 14) / 46);
if (n < 490) return (35928 + (n - 436) * 12 + ((n - 436) * 40) / 53);
if (n < 550) return (36604 + (n - 489) * 11 + ((n - 489) * 23) / 60);
if (n < 617) return (37287 + (n - 549) * 10 + ((n - 549) * 9) / 67);
if (n < 692) return (37966 + (n - 616) * 9 + ((n - 616) * 3) / 75);
if (n < 776) return (38644 + (n - 691) * 8 + ((n - 691) * 5) / 84);
if (n < 869) return (39321 + (n - 775) * 7 + ((n - 775) * 18) / 93);
if (n < 975) return (39990 + (n - 868) * 6 + ((n - 868) * 44) / 106);
if (n < 1093) return (40670 + (n - 974) * 5 + ((n - 974) * 85) / 118);
if (n < 1225) return (41345 + (n - 1092) * 5 + ((n - 1092) * 14) / 132);
if (n < 1374) return (42019 + (n - 1224) * 4 + ((n - 1224) * 82) / 149);
if (n < 1542) return (42697 + (n - 1373) * 4 + ((n - 1373) * 10) / 168);
if (n < 1729) return (43379 + (n - 1541) * 3 + ((n - 1541) * 115) / 187);
if (n < 1936) return (44055 + (n - 1728) * 3 + ((n - 1728) * 47) / 207);
if (n < 2166) return (44723 + (n - 1935) * 2 + ((n - 1935) * 204) / 230);
if (n < 2429) return (45387 + (n - 2165) * 2 + ((n - 2165) * 151) / 263);
if (n < 2723) return (46064 + (n - 2428) * 2 + ((n - 2428) * 87) / 294);
if (n < 3053) return (46739 + (n - 2722) * 2 + ((n - 2722) * 16) / 330);
if (n < 3420) return (47415 + (n - 3052) * 1 + ((n - 3052) * 304) / 367);
if (n < 3832) return (48086 + (n - 3419) * 1 + ((n - 3419) * 260) / 412);
if (n < 4290) return (48758 + (n - 3831) * 1 + ((n - 3831) * 209) / 458);
if (n < 4802) return (49425 + (n - 4289) * 1 + ((n - 4289) * 154) / 512);
if (n < 5373) return (50091 + (n - 4801) * 1 + ((n - 4801) * 93) / 571);
if (n < 6014) return (50755 + (n - 5372) * 1 + ((n - 5372) * 25) / 641);
if (n < 6732) return (51421 + (n - 6013) * 0 + ((n - 6013) * 667) / 718);
if (n < 7544) return (52088 + (n - 6731) * 0 + ((n - 6731) * 673) / 812);
if (n < 8457) return (52761 + (n - 7543) * 0 + ((n - 7543) * 675) / 913);
if (n < 9479) return (53436 + (n - 8456) * 0 + ((n - 8456) * 674) / 1022);
if (n < 10617) return (54110 + (n - 9478) * 0 + ((n - 9478) * 670) / 1138);
if (n < 11886) return (54780 + (n - 10616) * 0 + ((n - 10616) * 667) / 1269);
if (n < 13304) return (55447 + (n - 11885) * 0 + ((n - 11885) * 666) / 1418);
if (n < 14889) return (56113 + (n - 13303) * 0 + ((n - 13303) * 665) / 1585);
if (n < 16654) return (56778 + (n - 14888) * 0 + ((n - 14888) * 662) / 1765);
if (n < 18641) return (57440 + (n - 16653) * 0 + ((n - 16653) * 666) / 1987);
if (n < 20851) return (58106 + (n - 18640) * 0 + ((n - 18640) * 662) / 2210);
if (n < 23311) return (58768 + (n - 20850) * 0 + ((n - 20850) * 659) / 2460);
if (n < 26061) return (59427 + (n - 23310) * 0 + ((n - 23310) * 659) / 2750);
if (n < 29136) return (60086 + (n - 26060) * 0 + ((n - 26060) * 659) / 3075);
if (n < 32573) return (60745 + (n - 29135) * 0 + ((n - 29135) * 659) / 3437);
if (n < 36428) return (61404 + (n - 32572) * 0 + ((n - 32572) * 661) / 3855);
if (n < 40733) return (62065 + (n - 36427) * 0 + ((n - 36427) * 660) / 4305);
if (n < 45531) return (62725 + (n - 40732) * 0 + ((n - 40732) * 658) / 4798);
if (n < 50886) return (63383 + (n - 45530) * 0 + ((n - 45530) * 657) / 5355);
if (n < 56860) return (64040 + (n - 50885) * 0 + ((n - 50885) * 656) / 5974);
if (n < 63547) return (64696 + (n - 56859) * 0 + ((n - 56859) * 657) / 6687);
if (n < 65536) return (65353 + (n - 63546) * 0 + ((n - 63546) * 182) / 1989);
return -1;
}

int main(int argc, char *argv[])
{
	int i, j;
	int max = sizeof(crush_ln_table) / sizeof(crush_ln_table[0]);
#if 0
	for (i = 0; i < max; i++) {
		printf("i=%d\n", i);
		for (j = i+1; j < max; j++) {
			if (!is_linear(i, j)) {
				int delta = (val(j - 1) - val(i) ) / (j - 1 - i);
				int mod = (val(j - 1) - val(i) ) % (j - 1 - i);
		                printf ("if (n < %d) return (%d + (n - %d) * %d + ((n - %d) * %d) / %d);\n", j, val(i), i, delta, i, mod, j - i - 1);
				// printf ("%d %d -> %d\n", j - i, i, j - 1);
				i = j - 1;
				continue;
			}
		}
		// printf ("%d %d -> %d\n", j - i, i, j - 1);
		int delta = (val(j - 1) - val(i) ) / (j - 1 - i);
		int mod = (val(j - 1) - val(i) ) % (j - 1 - i);
		printf ("if (n < %d) return (%d + (n - %d) * %d + ((n - %d) * %d) / %d);\n", j, val(i), i, delta, i, mod, j - i - 1);
		break;

	}
#else
	for (i = 0; i < max; i++) {
		int orig = crush_ln_table[i];
		int prec10 = ln_precision10(i);
		printf("orig=%d p10=%d d=%d\n", orig, prec10, prec10 - orig);
	}
#endif

	return 0;
}
