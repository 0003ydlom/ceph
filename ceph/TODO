
SAGE:

- mount, unmount, distribute osdcluster

//- mpimessenger: allow self-addressed messages
//- change export_proxy_*'s to lists (faster)

//- make balancer export empty dirs

/- finish testing foreign renames

- no-cache tests

- basic client read, write.

- symlink loops

- fix MExportAck and others to use dir+dentry, not inode
  (otherwise this all breaks with hard links.. altho it probably needs reworking already!)

- timer .. integrate with clock?

- path_Traverse
  - fix noperm crap
  - clean up xlock interaction



- fix logging model for data safety
 - inodeupdate
 - dentryunlink
 - dentrylink
 - inodecreate
? - inodedestroy
 - put path to each item in log entry
 - EMkdir event?
   ?- properly commit dir, dirty inode+dentry

- readdir
 - include only lockable inodes
 - set up waiters for pending xlocks

fully document export process
 - including the whole warning business.. wtf is that about again?

/- export null dentries


for deadline:
- rush stub

- string table?

thing about:
/- xlock vs. discover?
- xlock vs import/export?

- think about global sync (to be used by shutdown)
  - flush all dirty data to disk
  - flush logs

- hard links

- do real permissions checks


CLIENT TODO

- put size and mtime in client close op?
- clean up rest of Request/Reply messages?
- statfs
- readdir content only optionally includes valid inode info
- open file modes and/or states (where the state is the effective global combination of all modes)
  - mode potentially distinct from open mode (i.e. might open RDWR, but only read for a while) ????
  - RDONLY
    - read from any replica
    - field day with buffer cache
  - RDWR
    - writes and reads are synchronous
    - writes to primary replica
  - WRONLY
    - field day with buffered/delayed write-back
    - writes to primary replica?


FILE STUFF

- send all file writers to auth
  - migrate open file ppl w/ export
  - simplify replica softlock craziness!

- locks versus import.. big mess!
  - consider active reader+writer on auth at time of export.  how to relax?
  - relaxation in general is tricky..
  - assimilating auth state on importer also tricky.  gather_set weirdness.

- half-assed async for file writers
 - auth needs to know about replicas with writers...
   - opens go to auth
   - auth has set of replica_writers
   - on close, replica tells auth
- replace replica_writers open/close bit will full-blown soft_start/soft_finish hooks?
- need to sync or qsync clients!

- import port soft writer on dir mtime/size...

- recall messages?
- lazy flag?  make a table!
- state diagram for master?  _eval() functions?


- think about softlock.mode versus shutdown
- qsync
- lock modes (sync, async)
 - recalls

- freeze interaction.....  test!
  - freeze state diagram?

- add client file handles.
  - fh modes:  RD, RDWR, WR ... append?  :/
  - fh states: SYNC, ASYNC... LOCK? 



=> grep for FIXME :)




ISSUES


- discover
 - soft: authority selectively repicates, or sets a 'forward' flag in reply
 - hard: authority always replicates (eg. discover for export)
 - forward flag (see soft)
 - error flag   (if file not found, etc.)
 - [what was i talking about?] make sure waiters are properly triggered, either upon dir_rep update, or (empty!) discover reply


- log
  - overall logging strategy.  
    - currently (?): do everything immediately, reply when logged.
  - the log grows indefinitely




CLEANUP
- waiters after export... fix will_fail, will_delegate nonsense
 - should a subset of these waiters be triggered immediately after
   export, since discover-based contexts will just be forwarded to the
   new auth?


DOCUMENT
- cache, distributed cache structure and invariants
- export process
- hash/unhash process


TEST
- hashing
 - test hash/unhash operation
 - hash+export: encode list of replicated dir inodes so they can be discovered before import is procesed.
 - test nauthitems (wrt hashing?)


IMPLEMENT

- rename
- truncate

- hash + unhash!

- dir sync
 - stat of a dir should return dir size????
 - readdir of hashed dir

- softasync mode

- log MDS actions
  - imports/exports
  - hash/unhash

- smarter balancing
  - popularity calculation and management is inconsistent/wrong.
  - does it work?

- instrumentation!
- dump active config in run output somewhere

- anchors
- hard links
